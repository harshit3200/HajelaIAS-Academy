{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block custom_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock custom_css %}

{% block title %}Edit List-II Type Question - Hajela's IAS Academy (HIA){% endblock %}

{% block content %}
<div class="container-xxl py-5">
    <div class="container">
        {% if messages %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                {% for message in messages %}{{ message }}{% endfor %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
            <h6 class="section-title bg-white text-center text-primary px-3">Edit List-II Type Question</h6>
            <h1 class="mb-5">Update the List-II type question</h1>
        </div>

        <div class="row g-4">
            <div class="col-lg-12 wow fadeInUp" data-wow-delay="0.5s">
                <form id="simpleTypeForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}

                    <input type="hidden" name="questionType" value="simple_type">

                    <!-- Language and Script Fields -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6 mb-4">
                            <label for="language" class="form-label">Language(s)</label>
                            <select class="form-select" id="language" name="language" multiple required disabled>
                                <option value="e" selected>English</option>
                                {% if hindi_q %}<option value="h" selected>Hindi</option>{% endif %}
                            </select>
                        </div>
                        {% comment %} <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="script" name="script" required>
                                    <option value="">Select Script</option>
                                    <option value="Latin" {% if english_q.script == 'Latin' %}selected{% endif %}>Latin</option>
                                    <option value="Devanagari" {% if english_q.script == 'Devanagari' %}selected{% endif %}>Devanagari</option>
                                </select>
                                <label for="script">Script</label>
                            </div>
                        </div> {% endcomment %}
                    </div>

                    <!-- Question Parts -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6 mb-3">
                            <label for="question_part_first" class="text-primary fw-bold">Question (English)</label>
                            <div class="form-floating">
                                <textarea class="form-control" name="question_part_first" id="question_part_first" required>{{ english_q.question_part_first }}</textarea>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="question_part_first_hi" class="text-primary fw-bold">Question (Hindi)</label>
                            <div class="form-floating">
                                <textarea class="form-control" name="question_part_first_hi" id="question_part_first_hi">{% if hindi_q %}{{ hindi_q.question_part_first_hi }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>
                    <!-- List Headings -->
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" name="list_1_name" placeholder="List-I Heading (English)">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" name="list_1_name_hi" placeholder="List-I Heading (Hindi)">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" name="list_2_name" placeholder="List-II Heading (English)">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" name="list_2_name_hi" placeholder="List-II Heading (Hindi)">
                        </div>
                    </div>
                    
                    <!-- List Items -->
                    <div class="row g-3 mt-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">List-I Items</label>
                            {% for i in "123456" %}
    {% with list1_key="list_1_row"|add:i %}
    {% with list1_hi_key=list1_key|add:"_hi" %}
    <div class="input-group mb-2">
        <input type="text" class="form-control" name="{{ list1_key }}" placeholder="List-I Item {{ i }} (English)" value="{{ english_q|get_dynamic_field:list1_key }}">
        <input type="text" class="form-control" name="{{ list1_hi_key }}" placeholder="List-I Item {{ i }} (Hindi)" value="{{ hindi_q|get_dynamic_field:list1_hi_key }}">
    </div>
    {% endwith %}
    {% endwith %}
{% endfor %}

                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">List-II Items</label>
                            {% for i in "123456" %}
    {% with list2_key="list_2_row"|add:i %}
    {% with list2_hi_key=list2_key|add:"_hi" %}
    <div class="input-group mb-2">
        <input type="text" class="form-control" name="{{ list2_key }}" placeholder="List-II Item {{ i }} (English)" value="{{ english_q|get_dynamic_field:list2_key }}">
        <input type="text" class="form-control" name="{{ list2_hi_key }}" placeholder="List-II Item {{ i }} (Hindi)" value="{{ hindi_q|get_dynamic_field:list2_hi_key }}">
    </div>
    {% endwith %}
    {% endwith %}
{% endfor %}

                        </div>
                    </div>
                    
                    
                    <!-- Question Part Third -->
                    <div class="row g-3 mt-3">
                        <div class="col-md-6 mb-4">
                            <textarea class="form-control" name="question_part_third" id="question_part_third" placeholder="Question Part Third (English)"></textarea>
                        </div>
                        <div class="col-md-6 mb-4">
                            <textarea class="form-control" name="question_part_third_hi" id="question_part_third_hi" placeholder="Question Part Third (Hindi)"></textarea>
                        </div>
                    </div>

                    <!-- Question Part Third -->
                    <div class="row g-3 mt-3">
                        <div class="col-md-6 mb-4">
                            <textarea class="form-control" name="question_part_third" id="question_part_third" placeholder="Question Part Third (English)">{{ english_q.question_part_third }}</textarea>
                        </div>
                        <div class="col-md-6 mb-4">
                            <textarea class="form-control" name="question_part_third_hi" id="question_part_third_hi" placeholder="Question Part Third (Hindi)">{{ hindi_q.question_part_third_hi }}</textarea>
                        </div>
                    </div>


                    <!-- Options -->
                    <!-- Options -->
<div class="row g-3 mb-4">
    <div class="col-md-6 mb-3">
        <label for="answer_option_a" class="form-label">Option A (English)</label>
        <input type="text" class="form-control" name="answer_option_a" id="answer_option_a" value="{{ english_q.answer_option_a }}" required>
    </div>
    <div class="col-md-6 mb-3">
        <label for="answer_option_a_hi" class="form-label">Option A (Hindi)</label>
        <input type="text" class="form-control" name="answer_option_a_hi" id="answer_option_a_hi" value="{% if hindi_q %}{{ hindi_q.answer_option_a_hi }}{% endif %}">
    </div>

    <div class="col-md-6 mb-3">
        <label for="answer_option_b" class="form-label">Option B (English)</label>
        <input type="text" class="form-control" name="answer_option_b" id="answer_option_b" value="{{ english_q.answer_option_b }}" required>
    </div>
    <div class="col-md-6 mb-3">
        <label for="answer_option_b_hi" class="form-label">Option B (Hindi)</label>
        <input type="text" class="form-control" name="answer_option_b_hi" id="answer_option_b_hi" value="{% if hindi_q %}{{ hindi_q.answer_option_b_hi }}{% endif %}">
    </div>

    <div class="col-md-6 mb-3">
        <label for="answer_option_c" class="form-label">Option C (English)</label>
        <input type="text" class="form-control" name="answer_option_c" id="answer_option_c" value="{{ english_q.answer_option_c }}" required>
    </div>
    <div class="col-md-6 mb-3">
        <label for="answer_option_c_hi" class="form-label">Option C (Hindi)</label>
        <input type="text" class="form-control" name="answer_option_c_hi" id="answer_option_c_hi" value="{% if hindi_q %}{{ hindi_q.answer_option_c_hi }}{% endif %}">
    </div>

    <div class="col-md-6 mb-3">
        <label for="answer_option_d" class="form-label">Option D (English)</label>
        <input type="text" class="form-control" name="answer_option_d" id="answer_option_d" value="{{ english_q.answer_option_d }}" required>
    </div>
    <div class="col-md-6 mb-3">
        <label for="answer_option_d_hi" class="form-label">Option D (Hindi)</label>
        <input type="text" class="form-control" name="answer_option_d_hi" id="answer_option_d_hi" value="{% if hindi_q %}{{ hindi_q.answer_option_d_hi }}{% endif %}">
    </div>
</div>


                    <!-- Correct Answer and Explanation -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6 mb-4">
                            <div class="form-floating">
                                <select class="form-select" id="correctAnswer" name="correct_answer_choice" required>
                                    <option value="">Select the correct answer</option>
                                    {% for option in 'abcd' %}
                                        <option value="{{ option }}" {% if english_q.correct_answer_choice == option %}selected{% endif %}>Option {{ option }}</option>
                                    {% endfor %}
                                </select>
                                <label for="correctAnswer">Correct Answer</label>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <label for="answerDescription" class="form-label">Answer Explanation (English)</label>
                            <div class="form-floating">
                                <textarea class="form-control" id="answerDescription" name="correct_answer_description">{{ english_q.correct_answer_description }}</textarea>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4 offset-md-6">
                            <label for="answerDescription_hi" class="form-label">Answer Explanation (Hindi)</label>
                            <div class="form-floating">
                                <textarea class="form-control" id="answerDescription_hi" name="correct_answer_description_hi">{% if hindi_q %}{{ hindi_q.correct_answer_description_hi }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>

{# --- REPLACE your existing "Other Details" block with this --- #}
<!-- Other details -->
<div class="row g-3">
  <label class="form-label">Other Details</label>

  <!-- Source (use 'modern' UI option but keep selection based on moq/pyq/osq) -->
  <div class="col-md-6 mb-4">
    <label for="questionTypeSelector" class="form-label">Select Question Source</label>
    <select class="form-select" id="questionTypeSelector" name="question_type_source" required>
      <option value="">Select Type</option>
      <option value="modern" {% if english_q.type_of_question == 'moq' %}selected{% endif %}>Model (New)</option>
      <option value="pyq" {% if english_q.type_of_question == 'pyq' %}selected{% endif %}>PYQ</option>
      <option value="osq" {% if english_q.type_of_question == 'osq' %}selected{% endif %}>OSQ (Other Source Question)</option>
    </select>
  </div>

<!-- Shortcode (optional helper to auto-fill the cascade) -->
<div class="col-md-6 mb-4">
  <label for="subTopicShortCode" class="form-label">Sub Topic Short Code</label>
  <input type="text" class="form-control" id="subTopicShortCode" name="sub_topic_short_code" placeholder="Enter Sub Topic Short Code">
  <div class="form-text">Auto-fills hierarchy when short code is matched</div>
</div>


  <!-- Area -->
  <div class="col-md-6 mb-4">
    <label for="areaName" class="form-label">Area Name(s)</label>
    <select id="areaName" name="area_name[]" class="form-control select2" multiple>
      {% for area in areas %}
        <option value="{{ area.area_SI_Code }}" {% if area.area_SI_Code|stringformat:"s" in selected_area_ids %}selected{% endif %}>{{ area.name }}</option>
      {% endfor %}
    </select>
    <div class="form-text">Hold Ctrl (Windows) or Command (Mac) to select multiple areas.</div>
  </div>

  <!-- Section -->
  <div class="col-md-6 mb-4">
    <label for="sectionName" class="form-label">Section Name(s)</label>
    <select id="sectionName" name="section_name[]" class="form-control select2" multiple disabled>
      <option value="no_section">No Section</option>
      {% for section in sections %}
        <option value="{{ section.section_Unit_SI }}" {% if section.section_Unit_SI|stringformat:"s" in selected_section_ids %}selected{% endif %}>{{ section.name }}</option>
      {% endfor %}
    </select>
    <div class="form-text">Select area(s) first to load related sections.</div>
  </div>

  <!-- Part -->
  <div class="col-md-6 mb-4">
    <label for="partName" class="form-label">Part Name(s)</label>
    <select id="partName" name="part_name[]" class="form-control select2" multiple disabled>
      {% for part in parts %}
        <option value="{{ part.part_serial }}" {% if part.part_serial|stringformat:"s" in selected_part_ids %}selected{% endif %}>{{ part.name }}</option>
      {% endfor %}
    </select>
    <div class="form-text">Select section(s) first to load related parts.</div>
  </div>

  <!-- Chapter -->
  <div class="col-md-6 mb-4">
    <label for="chapterName" class="form-label">Chapter Name(s)</label>
    <select id="chapterName" name="chapter_name[]" class="form-control select2" multiple disabled>
      {% for chapter in chapters %}
        <option value="{{ chapter.chapter_number }}" {% if chapter.chapter_number|stringformat:"s" in selected_chapter_ids %}selected{% endif %}>{{ chapter.name }}</option>
      {% endfor %}
    </select>
    <div class="form-text">Select part(s) first to load related chapters.</div>
  </div>

  <!-- Topic -->
  <div class="col-md-6 mb-4">
    <label for="topicName" class="form-label">Topic Name(s)</label>
    <select id="topicName" name="topic_name[]" class="form-control select2" multiple disabled>
      {% for topic in topics %}
        <option value="{{ topic.topic_SI_number }}" {% if topic.topic_SI_number|stringformat:"s" in selected_topic_ids %}selected{% endif %}>{{ topic.name }}</option>
      {% endfor %}
    </select>
    <div class="form-text">Select chapter(s) first to load related topics.</div>
  </div>

<!-- Subtopic (name aligned to subtopic_name[]) -->
<div class="col-md-6 mb-4">
  <label for="subTopicName" class="form-label">Sub Topic Name(s)</label>
  <select id="subTopicName" name="subtopic_name[]" class="form-control select2" multiple disabled>
    {% for subtopic in subtopics %}
      <option
        value="{{ subtopic.sub_topic_SI_Number }}"
        data-shortcode="{{ subtopic.sub_topic_short_Code|default_if_none:'' }}"
        {% if subtopic.sub_topic_SI_Number|stringformat:"s" in selected_subtopic_ids %}selected{% endif %}
      >
        {{ subtopic.name }}
      </option>
    {% endfor %}
  </select>

  <!-- Hidden mirror so legacy views reading 'sub_topic_name[]' still work -->
  <div id="subtopicHiddenMirror"></div>

  <div class="form-text">Select topic(s) first to load related subtopics.</div>
</div>


  <!-- Exams (with preselect support) -->
  <div class="col-md-6 mb-4">
    <label for="examName" class="form-label">Exam Name</label>
    <select id="examName"
            name="exam_name[]"
            class="form-control select2"
            multiple
            required
            disabled
            data-preselected-exams='{{ selected_exam_ids|default:"[]"|safe }}'>
      <option value="">Select Exam</option>
      {# You may leave this empty to be filled by JS after subtopic change; keeping static options is OK too #}
      {% for exam in exams %}
        {% with exam_id_str=exam.exam_SI_Number|stringformat:"s" %}
          <option value="{{ exam.exam_SI_Number }}" {% if exam_id_str in selected_exam_ids %}selected{% endif %}>
            {{ exam.name }}{% if exam.exam_code %} ({{ exam.exam_code }}){% endif %}
          </option>
        {% endwith %}
      {% endfor %}
    </select>
    <div id="relatedExamsContainer" class="exam-tag-container mt-2"></div>
    <div class="form-text">Select Sub topic(s) first to load related Exam Name.</div>
  </div>

  <!-- Exam Year -->
  <div class="col-md-6 mb-4 examYearFieldContainer" id="examYearField" style="display: {% if english_q.type_of_question == 'pyq' %}block{% else %}none{% endif %};">
    <div class="form-floating">
      <input type="number" class="form-control" id="year" name="exam_year" placeholder="Year" value="{{ english_q.exam_year }}">
      <label for="year">Year</label>
    </div>
  </div>

  <!-- Marks -->
  <div class="col-md-6 mb-4">
    <label for="marks">Marks</label>
    <div class="form-floating">
      <select class="form-select" id="marks" name="marks" required>
        <option value="">Select Marks</option>
        {% for val in mark_options %}
          <option value="{{ val }}" {% if english_q.marks|stringformat:"s" == val %}selected{% endif %}>{{ val }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Negative Marks -->
  <div class="col-md-6 mb-4">
    <label for="negativeMarks">Negative Marks</label>
    <div class="form-floating">
      <select class="form-select" id="negativeMarks" name="negative_marks" required>
        <option value="">Select Negative Marks</option>
        {% for val in negative_mark_options %}
          <option value="{{ val }}" {% if english_q.negative_marks|stringformat:"s" == val %}selected{% endif %}>{{ val }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Degree of Difficulty -->
  <div class="col-md-6 mb-4">
    <label for="degreeOfDifficulty">Degree of Difficulty</label>
    <div class="form-floating">
      <select class="form-select" id="degreeOfDifficulty" name="degree_of_difficulty" required>
        <option value="">Select Degree of Difficulty</option>
        {% for i in range_1_to_5 %}
          <option value="{{ i }}" {% if english_q.degree_of_difficulty|stringformat:"s" == i|stringformat:"s" %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

<!-- Elimination Tactics -->
<div class="col-md-6 mb-4">
  <label for="elimTacticsDegree" class="form-label">Elimination Tactics</label>
  <div class="form-floating">
    <select class="form-select" id="elimTacticsDegree" name="elim_tactics_degree" required>
      <option value="">Select Elimination Tactics</option>
      {# Prefer context-provided range_1_to_5; fall back to literal 1..5 if not provided #}
      {% if range_1_to_5 %}
        {% for i in range_1_to_5 %}
          {% with selected_val=english_q.elim_tactics_degree|stringformat:"s"|default_if_none:"" %}
            <option value="{{ i }}" {% if selected_val == i|stringformat:"s" %}selected{% endif %}>{{ i }}</option>
          {% endwith %}
        {% endfor %}
      {% else %}
        {% for i in "1,2,3,4,5"|split:"," %}
          {% with selected_val=english_q.elim_tactics_degree|stringformat:"s"|default_if_none:"" %}
            <option value="{{ i }}" {% if selected_val == i %}selected{% endif %}>{{ i }}</option>
          {% endwith %}
        {% endfor %}
      {% endif %}
    </select>
    <label for="elimTacticsDegree">Elimination Tactics</label>
  </div>
</div>

<!-- Current Relevance -->
<div class="col-md-6 mb-4">
  <label for="currentRelevance" class="form-label">Current Relevance</label>
  <div class="form-floating">
    {% with curr=english_q.current_relevance|default_if_none:"" %}
      <select class="form-select" id="currentRelevance" name="current_relevance" required>
        <option value="">Select Current Relevance</option>
        <option value="0" {% if curr|stringformat:"s" == "0" %}selected{% endif %}>0 - Not Relevant</option>
        <option value="1" {% if curr|stringformat:"s" == "1" %}selected{% endif %}>1 - Moderately Relevant</option>
        <option value="2" {% if curr|stringformat:"s" == "2" %}selected{% endif %}>2 - Very Relevant</option>
      </select>
    {% endwith %}
    <label for="currentRelevance">Current Relevance</label>
  </div>
</div>

  <!-- Current Relevance Topic -->
  <div class="col-md-6 mb-4">
    <label for="currentRelevanceTopic" class="form-label">Current Relevance Topic Explanation</label>
    <div class="form-floating">
      <textarea class="form-control" id="currentRelevanceTopic" name="current_relevance_topic" placeholder="Current Relevance Topic Explanation">{{ english_q.current_relevance_topic }}</textarea>
    </div>
  </div>
</div>


                        <!-- Submit Button -->
                        <div class="col-12 mt-3">
                            <button class="btn btn-primary w-100 py-3" type="submit">Update Question</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Simple Type Question Form End -->
{% endblock content %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function () {
  let questionTypeSource = $('#questionTypeSelector').val() || '';

  // Init Select2
  $('#areaName,#sectionName,#partName,#chapterName,#topicName,#subTopicName,#examName,#language,#elim_tactics_degree,#elimTacticsDegree,#currentRelevance')
    .select2({ placeholder: "Select or search", allowClear: true });

  // Disable cascades initially
  disableDropdowns(['#sectionName', '#partName', '#chapterName', '#topicName', '#subTopicName', '#examName']);

  // Toggle Exam Year for PYQ
  toggleExamYear(questionTypeSource);
  $('#questionTypeSelector').on('change', function () {
    questionTypeSource = $(this).val() || '';
    toggleExamYear(questionTypeSource);
    resetAllDropdowns();
  });

  // ---- Hidden mirror so backend accepts either param name ----
  function syncSubtopicHiddenMirror() {
    const $mirror = $('#subtopicHiddenMirror');
    if (!$mirror.length) return; // in case not added yet
    $mirror.empty();
    const vals = ($('#subTopicName').val() || []).map(String);
    vals.forEach(v => {
      $mirror.append($('<input>', { type: 'hidden', name: 'sub_topic_name[]', value: v }));
    });
  }

  // ---- Autofill shortcode field from current subtopic selections (edit mode too) ----
  function autofillShortcodeFromSelection() {
    const codes = [];
    $('#subTopicName option:selected').each(function () {
      const code = ($(this).attr('data-shortcode') || '').trim();
      if (code) codes.push(code);
    });
    const unique = [...new Set(codes)];
    if (unique.length) $('#subTopicShortCode').val(unique.join(', '));
  }

  // ---------- Shortcode → Autofill full cascade ----------
  $('#subTopicShortCode').on('blur', async function () {
    const raw = $(this).val().trim();
    if (!raw) return;

    questionTypeSource = $('#questionTypeSelector').val() || '';
    if (!questionTypeSource) { alert("Please select 'Select Question Source' first."); return; }

    const codes = raw.split(/[\s,]+/).filter(Boolean);
    const query = codes.map(c => `codes[]=${encodeURIComponent(c)}`).join('&');

    try {
      const res = await fetch(`/question-bank/get-hierarchy-from-shortcode/?${query}`);
      const payload = await res.json();
      if (payload.status !== 'success') {
        alert('Invalid or not found shortcode(s).');
        resetAllDropdowns();
        return;
      }
      const d = payload.data;

      // 1) Area
      setDropdownValues('#areaName', d.area_ids);
      $('#areaName').trigger('change');

      // 2) Section / No section for modern
      if (questionTypeSource === 'modern' || questionTypeSource === 'moq') {
        $('#sectionName').html('<option value="no_section" selected>No Section</option>')
          .prop('disabled', true).trigger('change');
        await fetchDropdownData('#partName', `/question-bank/get-parts-by-area/`, d.area_ids, 'area_ids');
      } else {
        await fetchDropdownData('#sectionName', `/question-bank/get-sections-list/`, d.area_ids, 'area_ids');
        setDropdownValues('#sectionName', d.section_ids);
        $('#sectionName').prop('disabled', false).trigger('change');
        await fetchDropdownData('#partName', `/question-bank/get-parts-list/`, d.section_ids, 'section_ids');
      }
      setDropdownValues('#partName', d.part_ids);
      $('#partName').prop('disabled', false).trigger('change');

      // 3) Chapters
      await fetchDropdownData('#chapterName', `/question-bank/get-chapters-list/`, d.part_ids, 'part_ids');
      setDropdownValues('#chapterName', d.chapter_ids);
      $('#chapterName').prop('disabled', false).trigger('change');

      // 4) Topics
      await fetchDropdownData('#topicName', `/question-bank/get-topics-list/`, d.chapter_ids, 'chapter_ids');
      setDropdownValues('#topicName', d.topic_ids);
      $('#topicName').prop('disabled', false).trigger('change');

      // 5) Subtopics
      await fetchDropdownData('#subTopicName', `/question-bank/get-subtopics-list/`, d.topic_ids, 'topic_ids');
      setDropdownValues('#subTopicName', d.subtopic_ids);
      $('#subTopicName').prop('disabled', false).trigger('change');

      // Keep mirror in sync and fetch exams
      syncSubtopicHiddenMirror();
      $('#subTopicName').trigger('change');
    } catch (err) {
      console.error("Error fetching hierarchy:", err);
      alert("Failed to fetch data from shortcode(s).");
      resetAllDropdowns();
    }
  });

  // ---------- Cascade change handlers ----------
  $('#areaName').on('change', async function () {
    const ids = ($(this).val() || []).map(String);
    resetDropdowns(['#sectionName', '#partName', '#chapterName', '#topicName', '#subTopicName', '#examName']);

    if (ids.length) {
      if (questionTypeSource === 'modern' || questionTypeSource === 'moq' || questionTypeSource === 'osq') {
        $('#sectionName').html('<option value="no_section" selected>No Section</option>')
          .prop('disabled', true).trigger('change');
        await fetchDropdownData('#partName', `/question-bank/get-parts-by-area/`, ids, 'area_ids');
        enableDropdown('#partName');
      } else {
        await fetchDropdownData('#sectionName', `/question-bank/get-sections-list/`, ids, 'area_ids');
        enableDropdown('#sectionName');
      }
    }
  });

  $('#sectionName').on('change', async function () {
    if (questionTypeSource === 'modern' || questionTypeSource === 'moq') return;
    const ids = ($(this).val() || []).map(String);
    if (ids.length) {
      await fetchDropdownData('#partName', `/question-bank/get-parts-list/`, ids, 'section_ids');
      enableDropdown('#partName');
    } else {
      resetDropdowns(['#partName', '#chapterName', '#topicName', '#subTopicName', '#examName']);
    }
  });

  $('#partName').on('change', async function () {
    const ids = ($(this).val() || []).map(String);
    if (ids.length) {
      await fetchDropdownData('#chapterName', `/question-bank/get-chapters-list/`, ids, 'part_ids');
      enableDropdown('#chapterName');
    } else {
      resetDropdowns(['#chapterName', '#topicName', '#subTopicName', '#examName']);
    }
  });

  $('#chapterName').on('change', async function () {
    const ids = ($(this).val() || []).map(String);
    if (ids.length) {
      await fetchDropdownData('#topicName', `/question-bank/get-topics-list/`, ids, 'chapter_ids');
      enableDropdown('#topicName');
    } else {
      resetDropdowns(['#topicName', '#subTopicName', '#examName']);
    }
  });

  $('#topicName').on('change', async function () {
    const ids = ($(this).val() || []).map(String);
    if (ids.length) {
      await fetchDropdownData('#subTopicName', `/question-bank/get-subtopics-list/`, ids, 'topic_ids');
      enableDropdown('#subTopicName');
    } else {
      resetDropdowns(['#subTopicName', '#examName']);
    }
  });

  // On-load (edit mode): enable controls with values, sync/mirror, prefetch exams
  (function initFromExisting() {
    ['#sectionName','#partName','#chapterName','#topicName','#subTopicName','#examName'].forEach(sel => {
      const $el = $(sel);
      if (($el.val() || []).length) $el.prop('disabled', false);
    });

    const subtopicVals = ($('#subTopicName').val() || []).map(String);
    if (subtopicVals.length) {
      syncSubtopicHiddenMirror();
      autofillShortcodeFromSelection(); // fill code box from current selections
      $('#subTopicName').trigger('change'); // fetch exams
    } else {
      // If a shortcode is already in the box (edit deep link), try to resolve it
      const existingCode = ($('#subTopicShortCode').val() || '').trim();
      if (existingCode) $('#subTopicShortCode').trigger('blur');
    }
  })();

  // ---------- SubTopic → Exams (preselect + tags) ----------
  $('#subTopicName').on('change', async function () {
    syncSubtopicHiddenMirror();       // keep legacy name posted
    autofillShortcodeFromSelection(); // keep code in sync with selection

    const ids = ($(this).val() || []).map(String);
    const examDropdown = $('#examName');
    const examTagContainer = $('#relatedExamsContainer');

    if (!ids.length) {
      resetDropdown('#examName', 'Select Exam');
      examTagContainer.empty();
      return;
    }

    try {
      const query = ids.map(id => `subtopic_ids[]=${encodeURIComponent(id)}`).join('&');
      const res = await fetch(`/question-bank/get-exams-list/?${query}`);
      const data = await res.json();

      const relatedIds = new Set((data.related_exams || []).map(e => String(e.exam_SI_Number)));

      // Preselected from server (edit mode)
      let serverPreselected = [];
      try {
        const raw = examDropdown.attr('data-preselected-exams') || '[]';
        serverPreselected = JSON.parse(raw).map(String);
      } catch (e) { serverPreselected = []; }

      examDropdown.empty().append(`<option value="">Select Exam</option>`);
      (data.all_exams || []).forEach(exam => {
        const value = String(exam.exam_SI_Number);
        const label = `${exam.name}${exam.exam_code ? ' (' + exam.exam_code + ')' : ''}`;
        const opt = $('<option>').val(value).text(label);
        if (relatedIds.has(value) || serverPreselected.includes(value)) opt.prop('selected', true);
        if (relatedIds.has(value)) opt.attr('data-related', '1'); // styling hook if needed
        examDropdown.append(opt);
      });

      examDropdown.prop('disabled', false).trigger('change');

      // Related tags (yellow chips)
      examTagContainer.empty();
      (data.related_exams || []).forEach(exam => {
        const tag = $('<div>').addClass('exam-tag').text(
          exam.exam_code ? `${exam.name} (${exam.exam_code})` : exam.name
        );
        examTagContainer.append(tag);
      });
      if (!data.related_exams || !data.related_exams.length) {
        examTagContainer.append('<div>No exams found.</div>');
      }
    } catch (err) {
      console.error("Error fetching exams:", err);
      resetDropdown('#examName', 'Select Exam');
      examTagContainer.empty();
    }
  });

  // Ensure disabled selects still POST values
  $('#simpleTypeForm').on('submit', function () {
    $('#sectionName, #partName, #chapterName, #topicName, #subTopicName, #examName').prop('disabled', false);
    syncSubtopicHiddenMirror(); // final sync
  });

  // ---------- Helpers ----------
  function toggleExamYear(source) {
    if (source === 'pyq') $('#examYearField').show();
    else $('#examYearField').hide();
  }

  async function fetchDropdownData(selector, url, ids, paramName) {
    const query = ids.map(id => `${paramName}[]=${encodeURIComponent(id)}`).join('&');
    const res = await fetch(`${url}?${query}`);
    const data = await res.json();
    const key = Object.keys(data)[0];
    if (Array.isArray(data[key]) && data[key].length) {
      populateDropdown(selector, data[key]);
    } else {
      resetDropdown(selector, `No data available`);
    }
  }

  // Adds data-shortcode when available for subtopics
  function populateDropdown(selector, items) {
    const dropdown = $(selector);
    dropdown.empty().append(`<option value="">Select ${dropdown.attr('id') || 'Option'}</option>`);

    const idKey = Object.keys(items[0]).find(k =>
      ['area_SI_Code','section_Unit_SI','part_serial','chapter_number','topic_SI_number','sub_topic_SI_Number','exam_SI_Number','id'].includes(k)
    );

    items.forEach(item => {
      const $opt = $('<option>').val(String(item[idKey])).text(item.name);
      // Preserve subtopic shortcode if provided by API payload
      if (selector === '#subTopicName' && (item.sub_topic_short_Code || item.short_code)) {
        $opt.attr('data-shortcode', item.sub_topic_short_Code || item.short_code);
      }
      dropdown.append($opt);
    });

    dropdown.trigger('change');
  }

  function setDropdownValues(selector, values) {
    const vals = (values || []).map(String);
    $(selector).val(vals).trigger('change');
  }

  function resetDropdowns(selectors) { selectors.forEach(sel => resetDropdown(sel, `Select ${capitalizeFirstLetter($(sel).attr('id')?.replace('Name','') || 'Option')}`)); }
  function resetDropdown(sel, placeholder) { $(sel).empty().append(`<option value="">${placeholder}</option>`).prop('disabled', true).trigger('change'); }
  function resetAllDropdowns() { resetDropdowns(['#sectionName','#partName','#chapterName','#topicName','#subTopicName','#examName']); }
  function enableDropdown(sel) { $(sel).prop('disabled', false); }
  function disableDropdowns(sels) { sels.forEach(sel => $(sel).prop('disabled', true)); }
  function capitalizeFirstLetter(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
});
</script>
{% endblock custom_js %}

